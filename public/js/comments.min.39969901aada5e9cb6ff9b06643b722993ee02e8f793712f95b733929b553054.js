document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("comments-section"),t=e?.getAttribute("data-bsky-uri");if(!t)return;(async()=>{try{const s=await extractAtUri(t);console.log("Extracted AT URI:",s);const n=await getPostThread(s);n&&n.$type==="app.bsky.feed.defs#threadViewPost"?renderComments(n,e):e.textContent="Error fetching comments."}catch(t){console.error("Error loading comments:",t),e.textContent="Error loading comments."}})()});async function extractAtUri(e){try{const o=new URL(e),t=o.pathname.split("/").filter(Boolean);if(t.length<4||t[0]!=="profile"||t[2]!=="post")throw new Error("Invalid URL format");const s=t[1],i=t[3];let n=s;if(!n.startsWith("did:")){const o=`https://bsky.social/xrpc/com.atproto.identity.resolveHandle?handle=${encodeURIComponent(s)}`,e=await fetch(o);if(!e.ok){const t=await e.text();throw new Error(`Failed to resolve handle to DID: ${t}`)}const t=await e.json();if(!t.did)throw new Error("DID not found in response");n=t.did}return`at://${n}/app.bsky.feed.post/${i}`}catch(e){throw console.error("Error extracting AT URI:",e),e}}async function getPostThread(e){console.log("getPostThread called with atUri:",e);const o=new URLSearchParams({uri:e}),s=`https://public.api.bsky.app/xrpc/app.bsky.feed.getPostThread?${o.toString()}`;console.log("API URL:",s);const t=await fetch(s,{method:"GET",headers:{Accept:"application/json"},cache:"no-store"});if(!t.ok){const e=await t.text();throw console.error("API Error:",e),new Error(`Failed to fetch post thread: ${e}`)}const n=await t.json();if(!n.thread||n.thread.$type!=="app.bsky.feed.defs#threadViewPost")throw new Error("Could not find thread");return n.thread}function renderComments(e,t){t.innerHTML="";const r=`https://bsky.app/profile/${e.post.author.did}/post/${e.post.uri.split("/").pop()}`,o=document.createElement("h2");o.textContent="Comments via ðŸ¦‹",o.className="comments-header",t.appendChild(o);const c=document.createElement("hr");t.appendChild(c);const i=document.createElement("div");i.className="comments-meta";const n=document.createElement("a");n.href=r,n.target="_blank",n.textContent=`${e.post.likeCount??0} likes | ${e.post.repostCount??0} reposts | ${e.post.replyCount??0} replies`,i.appendChild(n),t.appendChild(i);const a=document.createElement("p");a.className="join-conversation";const s=document.createElement("a");if(s.href=r,s.target="_blank",s.textContent="Join the conversation",a.appendChild(s),t.appendChild(a),e.replies&&e.replies.length>0){const n=document.createElement("div");n.id="comments-container";const s=e.replies.sort(sortByLikes);for(const e of s)isThreadViewPost(e)&&n.appendChild(renderComment(e));t.appendChild(n)}else{const e=document.createElement("p");e.textContent="No comments available.",t.appendChild(e)}}function renderComment(e){const{post:n}=e,{author:s}=n,t=document.createElement("div");t.className="comment";const o=document.createElement("div");if(o.className="author",s.avatar){const e=document.createElement("img");e.src=s.avatar,e.alt="avatar",e.className="avatar",o.appendChild(e)}const i=document.createElement("span");i.className="author-name",i.textContent=s.displayName??s.handle.split(".")[0],o.appendChild(i),t.appendChild(o);const r=document.createElement("p");r.textContent=n.record.text,t.appendChild(r);const a=document.createElement("div");if(a.className="actions",a.textContent=`${n.replyCount??0} replies | ${n.repostCount??0} reposts | ${n.likeCount??0} likes`,t.appendChild(a),e.replies&&e.replies.length>0){const n=document.createElement("div");n.className="nested-replies";const s=e.replies.sort(sortByLikes);for(const e of s)isThreadViewPost(e)&&n.appendChild(renderComment(e));t.appendChild(n)}return t}function sortByLikes(e,t){return!isThreadViewPost(e)||!isThreadViewPost(t)?0:(t.post.likeCount??0)-(e.post.likeCount??0)}function isThreadViewPost(e){return e&&e.$type==="app.bsky.feed.defs#threadViewPost"}