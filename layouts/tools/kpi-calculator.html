{{ define "main" }}
<div class="kpi-calculator-page">
    <article>
        <header>
            <h1>{{ .Params.headline | default .Title }}</h1>
            {{ with .Params.subheadline }}
                <p class="subheadline">{{ . }}</p>
            {{ end }}
        </header>

        {{/* Attention: Il problema principale */}}
        <section id="attention">
            {{ with .Params.attention_content }}
                <p>{{ . | markdownify }}</p>
            {{ else }}
                <p>Stai guidando la tua azienda guardando solo lo specchietto retrovisore del fatturato? Scopri perché la crescita dei ricavi non basta e come anticipare le sfide prima che sia troppo tardi.</p>
            {{ end }}
        </section>

        {{/* Interest: Cosa otterranno */}}
        <section id="interest">
            <h2>{{ .Params.interest_title | default "Scopri la Scalability KPI Dashboard" }}</h2>
            {{ with .Params.interest_intro }}
                <p>{{ . | markdownify }}</p>
            {{ else }}
                <p>Ho creato uno strumento semplice ma potente per aiutarti a monitorare i 5 indicatori chiave che *predicono* la tua reale capacità di scalare in modo sostenibile. Smetti di reagire, inizia a prevedere.</p>
            {{ end }}

            {{ with .Params.video_placeholder_text }}
                <div class="placeholder">{{ . }}</div>
            {{ else }}
                <div class="placeholder">[Placeholder: Video Loom Demo (1-2 min)]</div>
            {{ end }}

            <h3>Cosa otterrai monitorando questi KPI:</h3>
            {{ with .Params.benefits }}
                <ul>
                    {{ range . }}
                        <li>{{ . | markdownify }}</li>
                    {{ end }}
                </ul>
            {{ else }}
                <ul>
                    <li>Chiarezza sulla **sostenibilità commerciale** (rapporto LTV/CAC)</li>
                    <li>Controllo della **liquidità** e della velocità del capitale (Ciclo di Conversione di Cassa)</li>
                    <li>Visibilità sull'**efficienza operativa** reale (Margine Lordo)</li>
                    <li>Capacità di **replicare il successo** (Processi Standardizzati)</li>
                    <li>Solidità della **cultura e del know-how** (Mantenimento Talenti Chiave)</li>
                </ul>
            {{ end }}
        </section>

        {{/* Desire: Screenshot e prova sociale */}}
        <section id="desire">
            <h2>{{ .Params.desire_title | default "Progettato per Imprenditori e Manager Occupati" }}</h2>
            {{ with .Params.desire_intro }}
                <p>{{ . | markdownify }}</p>
            {{ else }}
                <p>Niente formule complesse o fogli di calcolo infiniti. Questa dashboard è pensata per darti una visione chiara e immediata dello stato di salute della tua scalabilità, con istruzioni semplici e benchmark di settore.</p>
            {{ end }}

            {{/* Implementazione del carosello di screenshot */}}
            <div class="screenshot-carousel swiper">
                <div class="swiper-wrapper">
                    {{ $cdnBaseUrl := "https://cdn.adlimen.com/tools/kpi-dashboard/" }}
                    {{ $imageNames := slice 
                        "scalability-kpi-01-welcome.jpg" 
                        "scalability-kpi-02-dashboard.jpg" 
                        "scalability-kpi-03-ltv-cac.jpg" 
                        "scalability-kpi-04-ltv-cac.jpg" 
                        "scalability-kpi-05-ccc.jpg" 
                        "scalability-kpi-06-margine.jpg" 
                        "scalability-kpi-07-processi-std.jpg" 
                        "scalability-kpi-08-talenti.jpg" 
                        "scalability-kpi-09-storici.jpg" 
                        "scalability-kpi-10-guide.jpg" 
                    }}
                    {{ range $index, $imageName := $imageNames }}
                        {{ $imgPath := print $cdnBaseUrl $imageName }}
                        <div class="swiper-slide">
                            <img src="{{ $imgPath }}" alt="Scalability KPI Dashboard - Screenshot {{ add $index 1 }}" class="dashboard-screenshot">
                        </div>
                    {{ end }}
                </div>
                <div class="swiper-pagination"></div>
                <div class="swiper-button-prev"></div>
                <div class="swiper-button-next"></div>
            </div>

            <!-- Optional: Placeholder for Social Proof/Testimonials -->
            <!--
            <div class="social-proof">
                <h3>Cosa dicono gli altri imprenditori:</h3>
                <div class="placeholder">[Placeholder: Testimonianze / Loghi Aziende]</div>
            </div>
            -->
        </section>

        {{/* Action: Form e CTA finale */}}
        <section id="action" class="cta-section">
            <h2>{{ .Params.action_title | default "Ottieni Subito la Tua Scalability KPI Dashboard Gratuita" }}</h2>
            {{ with .Params.action_intro }}
                <p>{{ . | markdownify }}</p>
            {{ else }}
                <p>Inserisci la tua email qui sotto per ricevere immediatamente il link alla Scalability KPI Dashboard e iniziare a prendere decisioni basate sui dati che contano davvero.</p>
            {{ end }}

            <div id="kpi-form-container" class="kpi-download-form-container">
                <form id="kpi-download-form" class="kpi-download-form">
                  <div class="form-row">
                    <input type="email" 
                          name="email"
                          placeholder="{{ if eq .Site.Language.Lang "en" }}Your email address{{ else }}Il tuo indirizzo email{{ end }}"
                          class="newsletter-form__input" 
                          aria-label="{{ if eq .Site.Language.Lang "en" }}Enter your email address{{ else }}Inserisci la tua email{{ end }}"
                          id="kpi-email"
                          autocomplete="email"
                          required>
                    <button id="kpi-submit" type="submit"
                            class="newsletter-form__button" 
                            aria-label="{{ if eq .Site.Language.Lang "en" }}Get the Dashboard{{ else }}Ottieni la Dashboard{{ end }}">
                      {{ with .Params.final_cta }}{{ . }}{{ else }}{{ if eq .Site.Language.Lang "en" }}Get the Dashboard{{ else }}Ottieni la Dashboard{{ end }}{{ end }}
                    </button>
                  </div>
                  
                  <div id="kpi-form-status" class="form-status" aria-live="polite" style="display: none;"></div>
                </form>
                <small style="display: block; text-align: center; margin-top: 0.5rem; color: var(--color-tx-muted);">
                  {{ if eq .Site.Language.Lang "en" }}We respect your privacy. Unsubscribe at any time.{{ else }}Rispettiamo la tua privacy. Puoi cancellare l'iscrizione in qualsiasi momento.{{ end }}
                </small>
            </div>
            
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const form = document.getElementById('kpi-download-form');
                const submitBtn = document.getElementById('kpi-submit');
                const statusMessage = document.getElementById('kpi-form-status');
                const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/1Y0GFlGVZnafTWBYsewsLpgG8blEp7fxa_8ruU4dpaBk/edit?usp=sharing';
                const language = '{{ .Site.Language.Lang }}';
                
                // Funzione per mostrare messaggi di stato
                function showStatus(message, type) {
                  statusMessage.textContent = message;
                  statusMessage.className = `form-status form-status--${type}`;
                  statusMessage.style.display = 'block';
                  
                  if (type === 'success') {
                    setTimeout(() => {
                      window.open(googleSheetUrl, '_blank');
                    }, 500);
                  }
                }
                
                // Funzione per attivare/disattivare stato di caricamento
                function toggleLoading(isLoading) {
                  submitBtn.disabled = isLoading;
                  submitBtn.classList.toggle('is-loading', isLoading);
                  submitBtn.setAttribute('aria-busy', isLoading);
                  
                  if (isLoading) {
                    submitBtn.dataset.originalText = submitBtn.textContent;
                    submitBtn.textContent = language === 'it' ? 'Attendere...' : 'Please wait...';
                  } else if (submitBtn.dataset.originalText) {
                    submitBtn.textContent = submitBtn.dataset.originalText;
                  }
                }
                
                // Gestione invio form
                form.addEventListener('submit', async function(event) {
                  event.preventDefault();
                  
                  const emailInput = document.getElementById('kpi-email');
                  const email = emailInput.value.trim();
                  
                  // Validazione email base
                  if (!email || !email.includes('@') || !email.includes('.')) {
                    showStatus(
                      language === 'it' ? 'Inserisci un indirizzo email valido.' : 'Please enter a valid email address.',
                      'error'
                    );
                    return;
                  }
                  
                  // Attiva stato di caricamento
                  toggleLoading(true);
                  statusMessage.style.display = 'none';
                  
                  try {
                    // Chiamata alla funzione Netlify
                    const response = await fetch('/.netlify/functions/request-kpi-confirmation', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json'
                      },
                      body: JSON.stringify({
                        email: email,
                        language: language
                      })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok && result.success) {
                      // Success
                      showStatus(
                        language === 'it' 
                          ? 'Email di conferma inviata! Controlla la tua casella di posta e apri il link per completare l\'iscrizione. Nel frattempo puoi accedere al tuo Google Sheet!' 
                          : 'Confirmation email sent! Check your inbox and open the link to complete your subscription. Meanwhile, you can access your Google Sheet!',
                        'success'
                      );
                      form.reset();
                    } else {
                      // API error
                      showStatus(result.message || (language === 'it' ? 'Si è verificato un errore. Riprova.' : 'An error occurred. Please try again.'), 'error');
                    }
                  } catch (error) {
                    // Network/other error
                    console.error('Error:', error);
                    showStatus(
                      language === 'it' ? 'Errore di rete. Riprova più tardi.' : 'Network error. Please try again later.',
                      'error'
                    );
                  } finally {
                    toggleLoading(false);
                  }
                });
              });
            </script>
        </section>
    </article>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    new Swiper('.screenshot-carousel', {
        slidesPerView: 1,
        spaceBetween: 30,
        loop: true,
        pagination: {
            el: '.swiper-pagination',
            clickable: true,
        },
        navigation: {
            nextEl: '.swiper-button-next',
            prevEl: '.swiper-button-prev',
        },
        autoplay: {
            delay: 5000,
            disableOnInteraction: false,
        },
        breakpoints: {
            768: {
                slidesPerView: 1
            }
        }
    });
});
</script>
{{ end }} 